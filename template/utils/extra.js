/*!
 * weapp-extra v2.2.11 (https://www.npmjs.com/package/weapp-extra)
 * Copyright 2018 seekwe@gmail.com, Inc.
 * Licensed under the Apache-2.0 license
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(t){for(var n=1;n<arguments.length;n++){var e=arguments[n];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])}return t},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};Promise.prototype.finally=function(t){function n(){setTimeout(t)}return this.then(n,n),this},wx._zlsBus=wx._zlsBus||{};var requestLimit=void 0,config={processes:10,host:"",rate:wx.getSystemInfoSync().windowWidth/750,requestBefore:null,requestAfter:null,afterApi:["request"]},utils=exports.utils={toRpx:function(t){return t/config.rate},toPx:function(t){return t*config.rate},getType:function(t){return Object.prototype.toString.call(t).slice(8,-1).toLowerCase()},checkUrl:function(t){if(t){if(/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:\/~\+#]*[\w\-\@?^=%&\/~\+#])?/.test(t))return!0}return!1}},mixin=exports.mixin=function(t){for(var n=arguments.length,e=Array(n>1?n-1:0),o=1;o<n;o++)e[o-1]=arguments[o];for(var i=Object.assign({},t),r=0,c=e.length;r<c;r++)!function(t,n){var o=e[t];for(var r in o)!function(t){var n=i[t];if(n){var e=utils.getType(n);if("function"===e)i[t]=function(){var e=[].slice.call(arguments);return o[t].call(this,e),n.call(this,e)};else if("object"===e&&utils.getType(o[t])==e)for(var r in o[t])n.hasOwnProperty(r)||(n[r]=o[t][r])}else i[t]=o[t]}(r)}(r);return i},component=exports.component=function(t){Component(mixin(t,{ready:function(t){hook(this),bindData(this),this.$zls=zls}}))},emit=exports.emit=function(t){for(var n=arguments.length,e=Array(n>1?n-1:0),o=1;o<n;o++)e[o-1]=arguments[o];var i=wx._zlsBus[t]||[],r=!0,c=!1,u=void 0;try{for(var f,s=i[Symbol.iterator]();!(r=(f=s.next()).done);r=!0){f.value.apply(void 0,e)}}catch(t){c=!0,u=t}finally{try{!r&&s.return&&s.return()}finally{if(c)throw u}}},on=exports.on=function(t,n){wx._zlsBus[t]=wx._zlsBus[t]||[],wx._zlsBus[t].push(n)},off=exports.off=function(t,n){var e=wx._zlsBus[t]||[];if(n){for(var o=0;o<e.length;++o)if(n===e[o]){e.splice(o,1);break}}else wx._zlsBus[t]=[]},page=exports.page=function(t){Page(mixin(t,{onLoad:function(t){hook(this),bindData(this),this.$zls=zls},onHide:function(){var t=this.$data;t.$hide=!0,t.$cache()},onShow:function(){var t=this.$data;t.$hide=!1,t.$commit()}}))},hook=exports.hook=function(t){function n(n,o,i,r){if(o||i||r)return e.call(t,n,o,i);t.$data=n}var e=t.setData;e.toString()!==n.toString()&&Object.defineProperty(t,"setData",{get:function(){return n}})},bindData=exports.bindData=function(t){function n(o,i,f){Object.defineProperty(o,i,{set:function(s){"object"===(void 0===s?"undefined":_typeof(s))?n(o,i,e(s)):f=s,r?c=!0:t.setData(u,null,null,!0)},get:function(){return f},enumerable:!0,configurable:!0})}function e(t){return"object"===utils.getType(t)?t=i(t):"array"===utils.getType(t)&&(t=o(t)),t}function o(t){for(var n=t,o=0;o<t.length;++o){var i=t[o];i=e(i),n[o]=i}return["push","pop","shift","unshift","splice","sort","reverse"].forEach(function(t){var e=n[t];n[t]=function(){var t=e.apply(this,[].slice.call(arguments));return c=!0,r||u.$commit(),t}}),n}function i(t){var o={};for(var i in t){var r=t[i];r=e(r),n(o,i,r)}return o}var r=!1,c=!1,u=void 0;u=i(t.data),Object.defineProperty(t,"$data",{set:function(t){u.$cache();for(var n in t)u[n]=t[n];u.$commit()},get:function(){return u},enumerable:!0,configurable:!0}),u.$set=function(t,o,i){"array"===utils.getType(t)?(i=e(i),t[o]=i,c=!0,r||u.$commit()):"object"===utils.getType(t)&&n(t,o,i)},u.$cache=function(){r=!0},u.$commit=function(){r=!1,c&&!u.$hide&&(c=!1,t.setData(u,null,null,!0))}},api=exports.api=function(t,n){for(var e=arguments.length,o=Array(e>2?e-2:0),i=2;i<e;i++)o[i-2]=arguments[i];var r="function"==typeof wx[t],c=config.requestAfter,u=config.afterApi.indexOf(t)>=0&&"function"==typeof c?c:null;return new Promise(function(e,i){if(r){if("function"!=typeof n){n=_extends({},n,{success:u?function(){e.apply(void 0,[u.apply(void 0,arguments),n].concat(o))}:e,fail:i})}if(customize[t])customize[t].apply(customize,[n].concat(o));else{var c;(c=wx)[t].apply(c,[n].concat(o))}}else i({errMsg:"API:"+t+"不存在，请尝试升级微信",type:"version"})})},openSetting=function(t){return new Promise(function(n,e){api("openSetting").then(function(o){getSetting(t,o).then(function(t){t?n(t):e(t)}).catch(function(t){e(t)})}).catch(function(t){e(t)})})},getSetting=exports.getSetting=function(t,n){var e=function(n){return n&&(!0===t||n.authSetting[t])};return new Promise(function(t,o){n?t(e(n)):api("getSetting").then(function(n){t(e(n))}).catch(function(n){t(n)})})},emitLogin=exports.emitLogin=function(t){if(t){if(t.detail&&(t=t.detail),t.userInfo)return emit(USER_EVENT_KEY,t),off(USER_EVENT_KEY),off(USER_EVENT_KEY+"__off__"),t}else emit(USER_EVENT_KEY+"__off__");return!1},USER_EVENT_KEY="__login__",login=exports.login=function(t,n){var e=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=function(t){return wx.setStorageSync(USER_EVENT_KEY,t)};return new Promise(function(i,r){var c=function(n){e?api("login").then(function(e){t(n,e)}).catch(function(t){}):t(n)},u=function t(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];api("getSetting").then(function(i){i.authSetting["scope.userInfo"]?api("getUserInfo").then(function(t){o(t),c(t)}).catch(function(t){n(t)}):(e&&(on(USER_EVENT_KEY,function(t){o(t),c(t)}),on(USER_EVENT_KEY+"__off__",function(n){t(!1)}),console.warn("请自行建立授权页面并且跳转/弹出授权按钮，然后在授权成功之后把结果传递给extra.emitLogin(res)")),n({type:"notAuth",errMsg:"还没授权"}))}).catch(function(t){n(t)})},f=wx.getStorageSync(USER_EVENT_KEY);f&&!e?wx.checkSession({success:function(){c(f)},fail:function(){e=!1,u()}}):u()})},authApi=function(t){for(var n=arguments.length,e=Array(n>6?n-6:0),o=6;o<n;o++)e[o-6]=arguments[o];var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,f=arguments[5];i||(i=!0);var s=void 0,a=void 0;return new Promise(function(n,o){a=function(){openSetting(i).then(function(t){l()}).catch(function(t){"version"===t.type?o(t):-1===r?p(s):u?wx.showModal(Object.assign({title:"提示",confirmText:"确定",content:"对应权限没有开启,部分功能受限",showCancel:!1,complete:function(){o(s)}},"string"==typeof u?{content:u}:!0===u?{}:u)):o(s)})},c=!!c&&Object.assign({title:"提示",confirmText:"确定",content:"请先开启对应权限",showCancel:!1},"string"==typeof c?{content:c}:!0===c?{}:c,{success:function(t){!0!==t.cancel&&a()}});var l=function(){api.apply(void 0,[t,f].concat(e)).then(function(t){n(t)}).catch(function(t){o(t)})},p=function(t){s||(s=t);t.type;c?wx.showModal(c):a()};api.apply(void 0,[t,f].concat(e)).then(function(t){n(t)}).catch(function(t){var n=t.type||"warn";t=_extends({type:n},t),"version"!==n&&0!==r?p(t):o(t)})})},runCount=exports.runCount=function(t,n){var e=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return function(){t--,(e?0===t:t<=0)&&n()}},runInit=exports.runInit=function(){var t=[];return function(n,e){if(t.push(n),e)for(var o=0,i=t.length;o<i;o++){var r=t.shift();r&&r(e)}}},runLimit=exports.runLimit=function(t){var n=[],e=0,o=function(){e--,i()},i=function(){if(n.length>0){n.shift()(o)}};return function(o){e++,n.push(o),e<=t&&i()}},requestBefore=exports.requestBefore=function(t){var n=config.requestBefore;return"function"==typeof n&&(t=n(t)),t},customize={uploadFile:function(t){for(var n=arguments.length,e=Array(n>1?n-1:0),o=1;o<n;o++)e[o-1]=arguments[o];this.processes.apply(this,["uploadFile",requestBefore(t)].concat(e))},downloadFile:function(t){for(var n=arguments.length,e=Array(n>1?n-1:0),o=1;o<n;o++)e[o-1]=arguments[o];this.processes.apply(this,["downloadFile",requestBefore(t)].concat(e))},request:function(t){for(var n=arguments.length,e=Array(n>1?n-1:0),o=1;o<n;o++)e[o-1]=arguments[o];this.processes.apply(this,["request",requestBefore(t)].concat(e))},processes:function(t,n){for(var e=arguments.length,o=Array(e>2?e-2:0),i=2;i<e;i++)o[i-2]=arguments[i];!1!==n&&(requestLimit||(requestLimit=runLimit(config.processes)),requestLimit(function(e){var i;n.complete=e,(i=wx)[t].apply(i,[n].concat(o))}))}},setConfig=exports.setConfig=function(t,n){"object"!==(void 0===t?"undefined":_typeof(t))&&n?config[t]=n:config=Object.assign(config,t)},getConfig=exports.getConfig=function(t){return t?config[t]:config},get=exports.get=function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return api("request",Object.assign({method:"GET",url:utils.checkUrl(t)?t:config.host+t},n))},post=exports.post=function(t,n){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return api("request",Object.assign({method:"POST",url:utils.checkUrl(t)?t:config.host+t,data:n,header:{"content-type":"application/x-www-form-urlencoded"}},e))};exports.default={api:api,page:page,component:component,mixin:mixin,on:on,off:off,emit:emit,emitLogin:emitLogin,get:get,post:post,authApi:authApi,login:login,utils:utils,getSetting:getSetting,runCount:runCount,runInit:runInit,runLimit:runLimit,setConfig:setConfig,getConfig:getConfig};
